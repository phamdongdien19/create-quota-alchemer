<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemer Bulk Quota Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8892b0;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #8892b0;
            font-weight: 500;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: rgba(0, 217, 255, 0.1);
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: #00d9ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d9ff, #00ff88);
            border-radius: 2px;
        }

        .card-title.danger::before {
            background: linear-gradient(180deg, #ff5252, #ff8a80);
        }

        .card-title.danger {
            color: #ff5252;
        }

        .card-title.warning::before {
            background: linear-gradient(180deg, #ffc107, #ffeb3b);
        }

        .card-title.warning {
            color: #ffc107;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #ccd6f6;
            font-weight: 500;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2);
        }

        textarea {
            min-height: 150px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 600px) {

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffeb3b);
            color: #1a1a2e;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff5252, #ff8a80);
            color: #fff;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 82, 82, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: 600;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table input {
            width: 80px;
            padding: 6px 10px;
            text-align: right;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .status-error {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .status-modified {
            background: rgba(138, 43, 226, 0.2);
            color: #da70d6;
        }

        .result-summary {
            display: flex;
            gap: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .result-stat {
            text-align: center;
        }

        .result-stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .result-stat-label {
            color: #8892b0;
            font-size: 0.9rem;
        }

        .success-value {
            color: #00ff88;
        }

        .error-value {
            color: #ff5252;
        }

        .total-value {
            color: #00d9ff;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .help-text {
            color: #8892b0;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .info-box {
            background: rgba(0, 217, 255, 0.1);
            border-left: 3px solid #00d9ff;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
        }

        .danger-box {
            background: rgba(255, 82, 82, 0.1);
            border-left: 3px solid #ff5252;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
        }

        .info-box p,
        .warning-box p,
        .danger-box p {
            color: #ccd6f6;
            line-height: 1.6;
        }

        .adjust-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .adjust-controls input {
            width: 80px;
        }

        .adjust-controls select {
            width: 120px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        .change-indicator {
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .change-up {
            color: #00ff88;
        }

        .change-down {
            color: #ff5252;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üöÄ Bulk Quota Manager</h1>
            <p class="subtitle">T·∫°o, ch·ªânh s·ª≠a v√† xo√° quota Alchemer h√†ng lo·∫°t</p>
        </header>

        <!-- API CONFIG -->
        <div class="card">
            <div class="card-title">C·∫•u h√¨nh API (Server-Side)</div>
            <div class="grid-3">
                <div>
                    <label>Survey ID</label>
                    <input type="text" id="surveyId" placeholder="VD: 8154556">
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('create')">‚ú® T·∫°o m·ªõi</div>
            <div class="tab" onclick="switchTab('manage')">üìù Qu·∫£n l√Ω & S·ª≠a</div>
            <div class="tab" onclick="switchTab('delete')">üóëÔ∏è Xo√°</div>
        </div>

        <!-- CREATE TAB -->
        <div id="createTab" class="tab-content active">
            <div class="card">
                <div class="card-title">C·∫•u h√¨nh Logic (M·∫∑c ƒë·ªãnh cho m·ªói Quota)</div>

                <!-- Template Selector -->
                <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="margin: 0;">üìÅ Template:</label>
                    <select id="logicTemplate" onchange="loadTemplate()" style="flex: 1; min-width: 200px;">
                        <option value="">-- Ch·ªçn template --</option>
                        <option value="link_panel">link = panel (Hidden Value)</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="saveCurrentAsTemplate()">üíæ L∆∞u</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate()">üóëÔ∏è</button>
                </div>

                <div class="grid-2">
                    <div>
                        <label>Lo·∫°i Logic</label>
                        <select id="logicAnswerType" onchange="updateLogicTypeUI()">
                            <option value="2" selected>Hidden Value (Text)</option>
                            <option value="17">Question Option (Single/Multiple Answer)</option>
                        </select>
                    </div>
                    <div>
                        <label>To√°n t·ª≠ (Operator)</label>
                        <select id="logicOperator" onchange="updateLogicPreview()">
                            <option value="4" selected>is exactly equal to (b·∫±ng)</option>
                            <option value="5">is not exactly equal to (kh√¥ng b·∫±ng)</option>
                            <option value="12">is one of the following answers</option>
                            <option value="13">is not one of the following answers</option>
                            <option value="20">is answered (ƒë√£ tr·∫£ l·ªùi)</option>
                            <option value="21">is not answered (ch∆∞a tr·∫£ l·ªùi)</option>
                            <option value="14">contains (ch·ª©a)</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2" style="margin-top: 16px;">
                    <div>
                        <label id="logicKeyLabel">Hidden Value ID</label>
                        <input type="text" id="logicKey" value="15" placeholder="VD: 15" oninput="updateLogicPreview()">
                        <p class="help-text" id="logicKeyHelp">üí° ID c·ªßa Hidden Value (VD: 15 cho "link")</p>
                    </div>
                    <div>
                        <label id="logicValueLabel">Gi√° tr·ªã (Value)</label>
                        <input type="text" id="logicValue" value="panel" placeholder="VD: panel"
                            oninput="updateLogicPreview()">
                        <p class="help-text" id="logicValueHelp">üí° Gi√° tr·ªã text ƒë·ªÉ so s√°nh</p>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <label class="checkbox-item">
                        <input type="checkbox" id="enableLogic" checked>
                        <span>S·ª≠ d·ª•ng Logic n√†y khi t·∫°o</span>
                    </label>
                    <span class="status status-success" style="font-size: 0.9rem;" id="logicPreview">Logic: HV[15] is
                        exactly equal to "panel"</span>
                </div>
            </div>

            <!-- Question Picker Tool -->
            <div class="card" id="questionPickerCard">
                <div class="card-title">üìã Ch·ªçn Questions ƒë·ªÉ t·∫°o Quota</div>

                <!-- Quick Add - Common Groups -->
                <div class="info-box" style="margin-bottom: 16px; background: rgba(0,255,136,0.1);">
                    <p style="margin-bottom: 10px;"><strong>‚ö° Th√™m nhanh nh√≥m ph·ªï bi·∫øn:</strong></p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="quickAddQuestion(87, 'province')">ÔøΩ Province
                            (87)</button>
                        <button class="btn btn-sm btn-primary" onclick="quickAddQuestion(93, 'age_group')">ÔøΩ Age Group
                            (93)</button>
                        <button class="btn btn-sm btn-primary" onclick="quickAddQuestion(75, 'family_income')">ÔøΩ Family
                            Income (75)</button>
                        <button class="btn btn-sm btn-primary" onclick="quickAddQuestion(150, 'gender')">‚öß Gender
                            (150)</button>
                        <button class="btn btn-sm btn-warning" onclick="quickAddMultipleQuestions([87, 93, 75, 150])">üî•
                            Th√™m t·∫•t c·∫£ 4 nh√≥m</button>
                    </div>
                </div>

                <div class="info-box" style="margin-bottom: 16px;">
                    <p>üí° Ho·∫∑c ch·ªçn th·ªß c√¥ng t·ª´ danh s√°ch Questions c√≥ options (Radio/Checkbox)</p>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="loadQuestionList(false)">üìã T·∫£i danh s√°ch
                        Questions</button>
                    <button class="btn btn-secondary" onclick="loadQuestionList(true)">üîÑ Refresh t·ª´ API</button>
                    <span id="questionCacheStatus" style="align-self: center; font-size: 0.85rem; opacity: 0.7;"></span>
                </div>

                <div id="questionListResult" class="hidden" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-sm btn-primary" onclick="addSelectedQuestionsToPreview()">‚úÖ Th√™m
                            Questions ƒë√£ ch·ªçn v√†o Xem tr∆∞·ªõc</button>
                        <span id="selectedQuestionsCount" style="font-size: 0.9rem;">0 ƒë√£ ch·ªçn</span>
                    </div>
                    <div
                        style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                        <table class="data-table" style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: #1a1a2e;">
                                <tr>
                                    <th><input type="checkbox" id="selectAllQuestions"
                                            onchange="toggleSelectAllQuestions(this)"></th>
                                    <th>ID</th>
                                    <th>T√™n Question</th>
                                    <th>Lo·∫°i</th>
                                    <th>Options</th>
                                </tr>
                            </thead>
                            <tbody id="questionListBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Manual lookup for single question -->
                <details style="margin-top: 16px;">
                    <summary
                        style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        üîç Tra c·ª©u th·ªß c√¥ng theo Question ID
                    </summary>
                    <div style="padding: 16px 0;">
                        <div class="grid-3">
                            <div>
                                <label>Question ID</label>
                                <input type="text" id="lookupQuestionId" placeholder="VD: 93">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-secondary" onclick="lookupQuestionOptions()">ÔøΩ Tra c·ª©u</button>
                            </div>
                        </div>
                        <div id="optionLookupResult" class="hidden" style="margin-top: 16px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Option</th>
                                        <th>Value</th>
                                        <th>Option ID (d√πng cho Logic)</th>
                                        <th>H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="optionLookupBody"></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>

            <div class="card">
                <div class="card-title">D·ªØ li·ªáu Quota</div>
                <div class="info-box">
                    <p>üìã Copy t·ª´ Google Sheet: <strong>T√™n [TAB] Limit [TAB] Nh√≥m (t√πy ch·ªçn)</strong></p>
                    <p style="font-size: 0.85rem; opacity: 0.8;">üí° Th√™m c·ªôt th·ª© 3 ƒë·ªÉ ph√¢n nh√≥m quota (VD: age_group,
                        location, gender)</p>
                </div>
                <textarea id="quotaData" placeholder="18-29	100	age_group
30-39	100	age_group
HCMC	300	location
Hanoi	300	location
Male	150	gender
Female	150	gender"></textarea>
            </div>

            <div class="card hidden" id="createPreviewCard">
                <div class="card-title">Xem tr∆∞·ªõc</div>

                <!-- Bulk Template Apply -->
                <div class="info-box" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <span>üìå √Åp d·ª•ng Logic cho c√°c m·ª•c ƒë√£ ch·ªçn:</span>
                        <select id="bulkTemplate" style="flex: 1; min-width: 180px;">
                            <option value="">-- Ch·ªçn template --</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="applyBulkTemplate()">‚úÖ √Åp d·ª•ng</button>
                        <button class="btn btn-sm btn-secondary" onclick="clearSelectedLogic()">üóëÔ∏è X√≥a Logic</button>
                        <button class="btn btn-sm btn-warning" onclick="addManualQuota()">‚ûï Th√™m quota th·ªß c√¥ng</button>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllQuotas" onchange="toggleSelectAll(this)"></th>
                            <th>#</th>
                            <th>T√™n Quota</th>
                            <th>Limit</th>
                            <th>Logic</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="createPreviewBody"></tbody>
                </table>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="parseCreateData()">üëÅÔ∏è Xem tr∆∞·ªõc</button>
                <button class="btn btn-warning hidden" id="undoBtn" onclick="undoDelete()">‚Ü©Ô∏è Ho√†n t√°c</button>
                <button class="btn btn-primary" id="createBtn" onclick="createQuotas()">‚ú® T·∫°o Quota</button>
            </div>

            <div class="card hidden" id="createResultsCard">
                <div class="card-title">K·∫øt qu·∫£</div>
                <div class="result-summary">
                    <div class="result-stat">
                        <div class="result-stat-value total-value" id="createTotal">0</div>
                        <div class="result-stat-label">T·ªïng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value success-value" id="createSuccess">0</div>
                        <div class="result-stat-label">Th√†nh c√¥ng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value error-value" id="createError">0</div>
                        <div class="result-stat-label">L·ªói</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MANAGE TAB -->
        <div id="manageTab" class="tab-content">
            <div class="card">
                <div class="card-title warning">üìù Qu·∫£n l√Ω & Ch·ªânh s·ª≠a Quota</div>
                <button class="btn btn-secondary" onclick="loadExistingQuotas()" id="loadManageBtn">üîÑ T·∫£i danh s√°ch
                    Quota</button>
            </div>

            <div class="card hidden" id="manageCard">
                <div class="card-title">ƒêi·ªÅu ch·ªânh h√†ng lo·∫°t</div>
                <div class="adjust-controls">
                    <span>Thay ƒë·ªïi Limit:</span>
                    <select id="adjustType">
                        <option value="percent">Theo %</option>
                        <option value="add">C·ªông th√™m</option>
                        <option value="set">ƒê·∫∑t gi√° tr·ªã</option>
                    </select>
                    <input type="number" id="adjustValue" value="10" placeholder="Gi√° tr·ªã">
                    <button class="btn btn-sm btn-secondary" onclick="applyAdjustment()">√Åp d·ª•ng</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetLimits()">‚Ü©Ô∏è Reset</button>
                </div>

                <div class="warning-box">
                    <p>‚ö†Ô∏è Ch·ªânh s·ª≠a Limit b√™n d∆∞·ªõi, sau ƒë√≥ nh·∫•n <strong>"C·∫≠p nh·∫≠t"</strong> ƒë·ªÉ l∆∞u thay ƒë·ªïi.</p>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllManage" onchange="toggleSelectAllManage()"></th>
                            <th>ID</th>
                            <th>T√™n Quota</th>
                            <th>Limit hi·ªán t·∫°i</th>
                            <th>Limit m·ªõi</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="manageBody"></tbody>
                </table>
            </div>

            <div class="actions hidden" id="manageActions">
                <button class="btn btn-warning" id="updateBtn" onclick="updateQuotas()">üíæ C·∫≠p nh·∫≠t Quota ƒë√£
                    ch·ªçn</button>
            </div>

            <div class="card hidden" id="updateResultsCard">
                <div class="card-title">K·∫øt qu·∫£ c·∫≠p nh·∫≠t</div>
                <div class="result-summary">
                    <div class="result-stat">
                        <div class="result-stat-value total-value" id="updateTotal">0</div>
                        <div class="result-stat-label">T·ªïng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value success-value" id="updateSuccess">0</div>
                        <div class="result-stat-label">Th√†nh c√¥ng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value error-value" id="updateError">0</div>
                        <div class="result-stat-label">L·ªói</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DELETE TAB -->
        <div id="deleteTab" class="tab-content">
            <div class="card">
                <div class="card-title danger">üóëÔ∏è Xo√° Quota H√†ng Lo·∫°t</div>
                <div class="danger-box">
                    <p>üö® <strong>C·∫©n th·∫≠n!</strong> H√†nh ƒë·ªông xo√° kh√¥ng th·ªÉ ho√†n t√°c.</p>
                </div>
                <button class="btn btn-secondary" onclick="loadDeleteQuotas()" id="loadDeleteBtn">üîÑ T·∫£i danh
                    s√°ch</button>

                <div id="deleteList" class="hidden" style="margin-top: 20px;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="selectAllDelete" onchange="toggleSelectAllDelete()">
                        <label for="selectAllDelete"><strong>Ch·ªçn t·∫•t c·∫£</strong></label>
                    </div>
                    <div id="deleteCheckboxes"></div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-danger hidden" id="deleteBtn" onclick="deleteSelectedQuotas()">üóëÔ∏è Xo√°
                    Quota</button>
            </div>

            <div class="card hidden" id="deleteResultsCard">
                <div class="card-title">K·∫øt qu·∫£ xo√°</div>
                <div class="result-summary">
                    <div class="result-stat">
                        <div class="result-stat-value total-value" id="deleteTotal">0</div>
                        <div class="result-stat-label">T·ªïng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value success-value" id="deleteSuccess">0</div>
                        <div class="result-stat-label">ƒê√£ xo√°</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value error-value" id="deleteError">0</div>
                        <div class="result-stat-label">L·ªói</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let createQuotasList = [];
        let manageQuotasList = [];
        let deleteQuotasList = [];
        let createDeletedHistory = []; // History for undo

        // Load settings
        window.onload = () => {
            document.getElementById('surveyId').value = localStorage.getItem('alchemer_surveyId') || '';
        };

        async function alchemerAPI(path, method = 'GET', params = {}, data = null) {
            const res = await fetch('/api/alchemer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, method, params, data })
            });
            return await res.json();
        }

        function saveSettings() {
            localStorage.setItem('alchemer_surveyId', document.getElementById('surveyId').value);
        }

        function getApiParams() {
            return {
                surveyId: document.getElementById('surveyId').value
            };
        }

        // ========== TEMPLATE MANAGEMENT ==========
        const DEFAULT_TEMPLATES = {
            'link_panel': {
                name: 'link = panel (Hidden Value)',
                answerType: '2',
                operator: '4',
                key: '15',
                value: 'panel'
            }
        };

        // Helper function to escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function getTemplates() {
            const saved = localStorage.getItem('quota_logic_templates');
            return saved ? { ...DEFAULT_TEMPLATES, ...JSON.parse(saved) } : { ...DEFAULT_TEMPLATES };
        }

        function saveTemplates(templates) {
            // Only save custom templates, not defaults
            const custom = {};
            for (const key in templates) {
                if (!DEFAULT_TEMPLATES[key]) {
                    custom[key] = templates[key];
                }
            }
            localStorage.setItem('quota_logic_templates', JSON.stringify(custom));
        }

        function refreshTemplateDropdown() {
            const select = document.getElementById('logicTemplate');
            const templates = getTemplates();
            select.innerHTML = '<option value="">-- Ch·ªçn template --</option>';
            for (const key in templates) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = templates[key].name;
                select.appendChild(opt);
            }
        }

        function loadTemplate() {
            const templateId = document.getElementById('logicTemplate').value;
            if (!templateId) return;

            const templates = getTemplates();
            const t = templates[templateId];
            if (!t) return;

            document.getElementById('logicAnswerType').value = t.answerType;
            document.getElementById('logicOperator').value = t.operator;
            document.getElementById('logicKey').value = t.key;
            document.getElementById('logicValue').value = t.value;

            updateLogicTypeUI();
        }

        function saveCurrentAsTemplate() {
            const name = prompt('Nh·∫≠p t√™n cho template m·ªõi:', '');
            if (!name) return;

            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const templates = getTemplates();

            templates[id] = {
                name: name,
                answerType: document.getElementById('logicAnswerType').value,
                operator: document.getElementById('logicOperator').value,
                key: document.getElementById('logicKey').value,
                value: document.getElementById('logicValue').value
            };

            saveTemplates(templates);
            refreshTemplateDropdown();
            document.getElementById('logicTemplate').value = id;
            alert('‚úÖ ƒê√£ l∆∞u template: ' + name);
        }

        function deleteTemplate() {
            const templateId = document.getElementById('logicTemplate').value;
            if (!templateId) return alert('Vui l√≤ng ch·ªçn template ƒë·ªÉ x√≥a');
            if (DEFAULT_TEMPLATES[templateId]) return alert('Kh√¥ng th·ªÉ x√≥a template m·∫∑c ƒë·ªãnh');

            if (!confirm('X√≥a template n√†y?')) return;

            const templates = getTemplates();
            delete templates[templateId];
            saveTemplates(templates);
            refreshTemplateDropdown();
            alert('‚úÖ ƒê√£ x√≥a template');
        }

        // Initialize templates on load
        document.addEventListener('DOMContentLoaded', refreshTemplateDropdown);

        // ========== OPTION LOOKUP ==========
        let lastLookupOptions = []; // Store for bulk operations
        let lastLookupQuestionId = '';
        let lastLookupQuestionName = '';

        async function lookupQuestionOptions() {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');

            const questionId = document.getElementById('lookupQuestionId').value;
            if (!questionId) return alert('Vui l√≤ng nh·∫≠p Question ID');

            const resultDiv = document.getElementById('optionLookupResult');
            const tbody = document.getElementById('optionLookupBody');
            tbody.innerHTML = '<tr><td colspan="4">‚è≥ ƒêang tra c·ª©u...</td></tr>';
            resultDiv.classList.remove('hidden');

            try {
                const data = await alchemerAPI(`survey/${surveyId}/question/${questionId}`);

                if (!data || !data.result_ok) {
                    tbody.innerHTML = `<tr><td colspan="4" style="color: #ff5252;">‚ùå ${data.message || 'Kh√¥ng t√¨m th·∫•y Question'}</td></tr>`;
                    return;
                }

                const question = data.data;
                const options = question.options || [];
                lastLookupOptions = options;
                lastLookupQuestionId = questionId;
                lastLookupQuestionName = question.title?.English || question.shortname || 'Question';

                if (options.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4">‚ö†Ô∏è Question n√†y kh√¥ng c√≥ options (c√≥ th·ªÉ l√† Text Box ho·∫∑c Hidden Value)</td></tr>`;
                    return;
                }

                // Add bulk action buttons
                let html = `<tr style="background: rgba(0,255,136,0.1);">
                    <td colspan="5">
                        <strong>üìã ${lastLookupQuestionName}</strong> (ID: ${questionId}) - ${options.length} options
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-primary" onclick="createAllOptionTemplates()">üíæ T·∫°o Templates cho t·∫•t c·∫£</button>
                            <button class="btn btn-sm btn-secondary" onclick="copyAllOptionIds()">üìã Copy t·∫•t c·∫£ Option IDs</button>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,193,7,0.1); border-radius: 8px;">
                            <strong>üîÄ G·ªôp nhi·ªÅu Options th√†nh 1 Quota:</strong>
                            <div style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="mergedQuotaName" placeholder="T√™n quota g·ªôp (VD: HHI > 30M)" style="flex: 1; min-width: 200px;">
                                <button class="btn btn-sm btn-warning" onclick="createMergedQuota()">‚úÖ T·∫°o Quota g·ªôp t·ª´ options ƒë√£ ch·ªçn</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr style="background: rgba(255,255,255,0.05);">
                    <th style="width: 40px;"><input type="checkbox" id="selectAllOptions" onchange="toggleSelectAllOptions(this)"></th>
                    <th>Option</th>
                    <th>Value</th>
                    <th>Option ID</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>`;

                html += options.map(opt => `
                    <tr>
                        <td><input type="checkbox" class="option-checkbox" data-id="${questionId}-${opt.id}" data-name="${opt.title?.English || opt.value || opt.id}"></td>
                        <td>${opt.title?.English || opt.title || '-'}</td>
                        <td>${opt.value || '-'}</td>
                        <td><code style="background: rgba(0,217,255,0.2); padding: 4px 8px; border-radius: 4px;">${questionId}-${opt.id}</code></td>
                        <td><button class="btn btn-sm btn-primary" onclick="useOptionId('${questionId}-${opt.id}')">üìã D√πng</button></td>
                    </tr>
                `).join('');

                tbody.innerHTML = html;

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" style="color: #ff5252;">‚ùå L·ªói: ${e.message}</td></tr>`;
                console.error('Lookup error:', e);
            }
        }

        function createAllOptionTemplates() {
            if (!lastLookupOptions.length) return alert('Ch∆∞a c√≥ options ƒë·ªÉ t·∫°o template');

            const groupName = prompt('Nh·∫≠p t√™n nh√≥m cho c√°c templates (VD: age_group):', lastLookupQuestionName.toLowerCase().replace(/\s+/g, '_'));
            if (!groupName) return;

            const templates = getTemplates();
            let created = 0;

            lastLookupOptions.forEach(opt => {
                const optName = opt.title?.English || opt.value || opt.id;
                const templateId = `${groupName}_${String(optName).toLowerCase().replace(/[^a-z0-9]/g, '_')}`;

                templates[templateId] = {
                    name: `${groupName}: ${optName}`,
                    answerType: '17',
                    operator: '12', // is one of
                    key: lastLookupQuestionId,
                    value: `${lastLookupQuestionId}-${opt.id}`
                };
                created++;
            });

            saveTemplates(templates);
            refreshTemplateDropdown();
            refreshBulkTemplateDropdown();

            alert(`‚úÖ ƒê√£ t·∫°o ${created} templates cho nh√≥m "${groupName}"!\n\nB·∫°n c√≥ th·ªÉ ch·ªçn template n√†y trong dropdown khi t·∫°o quota.`);
        }

        function copyAllOptionIds() {
            if (!lastLookupOptions.length) return alert('Ch∆∞a c√≥ options ƒë·ªÉ copy');

            const text = lastLookupOptions.map(opt => {
                const optName = opt.title?.English || opt.value || opt.id;
                return `${optName}\t100\t${lastLookupQuestionName}`;
            }).join('\n');

            navigator.clipboard.writeText(text).then(() => {
                alert(`‚úÖ ƒê√£ copy ${lastLookupOptions.length} d√≤ng v√†o clipboard!\n\nFormat: T√™n [TAB] Limit [TAB] Nh√≥m\n\nB·∫°n c√≥ th·ªÉ paste v√†o √¥ "D·ªØ li·ªáu Quota".`);
            }).catch(e => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert(`‚úÖ ƒê√£ copy ${lastLookupOptions.length} d√≤ng!`);
            });
        }

        function toggleSelectAllOptions(checkbox) {
            document.querySelectorAll('.option-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function createMergedQuota() {
            const selectedCheckboxes = document.querySelectorAll('.option-checkbox:checked');
            if (selectedCheckboxes.length < 2) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 2 options ƒë·ªÉ g·ªôp');

            const quotaName = document.getElementById('mergedQuotaName').value.trim();
            if (!quotaName) return alert('Vui l√≤ng nh·∫≠p t√™n cho quota g·ªôp');

            const optionIds = [];
            const optionNames = [];
            selectedCheckboxes.forEach(cb => {
                optionIds.push(cb.dataset.id);
                optionNames.push(cb.dataset.name);
            });

            // Create merged logic with multiple values
            const mergedLogic = {
                templateName: `${lastLookupQuestionName}: ${quotaName}`,
                answerType: '17',
                operator: '12', // is one of
                key: lastLookupQuestionId,
                value: optionIds // Array of option IDs
            };

            // Add to createQuotasList
            createQuotasList.push({
                name: quotaName,
                limit: 100,
                group: lastLookupQuestionName,
                status: 'pending',
                logic: mergedLogic,
                originalIndex: createQuotasList.length
            });

            // Also save as template
            const templates = getTemplates();
            const templateId = `merged_${quotaName.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
            templates[templateId] = {
                name: `${lastLookupQuestionName}: ${quotaName}`,
                answerType: '17',
                operator: '12',
                key: lastLookupQuestionId,
                value: optionIds.join(',') // Store as comma-separated for template
            };
            saveTemplates(templates);
            refreshTemplateDropdown();
            refreshBulkTemplateDropdown();

            renderCreatePreview();
            document.getElementById('createPreviewCard').classList.remove('hidden');

            // Clear selections
            document.querySelectorAll('.option-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllOptions').checked = false;
            document.getElementById('mergedQuotaName').value = '';

            alert(`‚úÖ ƒê√£ t·∫°o quota g·ªôp: "${quotaName}"\n\nG·ªìm ${optionIds.length} options:\n- ${optionNames.slice(0, 3).join('\n- ')}${optionNames.length > 3 ? '\n- ...' : ''}`);
        }

        // ========== QUESTION PICKER ==========
        let cachedQuestions = null;

        async function loadQuestionList(forceRefresh = false) {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');

            const cacheKey = `questions_${surveyId}`;
            const cacheStatus = document.getElementById('questionCacheStatus');
            const resultDiv = document.getElementById('questionListResult');
            const tbody = document.getElementById('questionListBody');

            // Try to load from cache first
            if (!forceRefresh) {
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    cachedQuestions = data;
                    cacheStatus.textContent = `üì¶ T·ª´ cache (${new Date(timestamp).toLocaleString()})`;
                    renderQuestionList(data);
                    resultDiv.classList.remove('hidden');
                    return;
                }
            }

            // Load from API
            tbody.innerHTML = '<tr><td colspan="5">‚è≥ ƒêang t·∫£i t·ª´ API...</td></tr>';
            resultDiv.classList.remove('hidden');

            try {
                const data = await alchemerAPI(`survey/${surveyId}/question`);

                if (!data || !data.result_ok) {
                    tbody.innerHTML = `<tr><td colspan="5" style="color: #ff5252;">‚ùå ${data.message || 'L·ªói'}</td></tr>`;
                    return;
                }

                // Filter only questions with potential options (Radio, Checkbox, Dropdown, etc.)
                const questions = (data.data || []).filter(q =>
                    ['RADIO', 'CHECKBOX', 'MENU', 'SELECT', 'RANK'].includes(q.type) ||
                    q.type?.includes('RADIO') || q.type?.includes('CHECKBOX')
                );

                // Save to cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    data: questions,
                    timestamp: Date.now()
                }));
                cachedQuestions = questions;
                cacheStatus.textContent = `‚úÖ M·ªõi t·∫£i (${questions.length} questions)`;

                renderQuestionList(questions);

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="color: #ff5252;">‚ùå L·ªói: ${e.message}</td></tr>`;
                console.error('Load error:', e);
            }
        }

        function renderQuestionList(questions) {
            const tbody = document.getElementById('questionListBody');

            if (questions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Questions c√≥ options</td></tr>';
                return;
            }

            tbody.innerHTML = questions.map(q => {
                const qName = escapeHtml(q.title?.English || q.shortname || 'Question');
                return `
                <tr>
                    <td><input type="checkbox" class="question-checkbox" data-id="${q.id}" data-name="${qName}" data-type="${q.type}" onchange="updateSelectedCount()"></td>
                    <td><code>${q.id}</code></td>
                    <td>${qName}</td>
                    <td><span class="status status-pending" style="font-size: 0.75rem;">${q.type}</span></td>
                    <td>--</td>
                </tr>`;
            }).join('');
        }

        function toggleSelectAllQuestions(checkbox) {
            document.querySelectorAll('.question-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.question-checkbox:checked').length;
            document.getElementById('selectedQuestionsCount').textContent = `${count} ƒë√£ ch·ªçn`;
        }

        async function addSelectedQuestionsToPreview() {
            const { surveyId } = getApiParams();
            const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');

            if (selectedCheckboxes.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 Question');

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang t·∫£i options...';

            let newQuotas = [];
            let templates = getTemplates();

            for (const cb of selectedCheckboxes) {
                const questionId = cb.dataset.id;
                const questionName = cb.dataset.name;

                try {
                    const data = await alchemerAPI(`survey/${surveyId}/question/${questionId}`);

                    if (data.result_ok && data.data.options) {
                        const groupName = questionName.toLowerCase().replace(/[^a-z0-9]/g, '_');

                        data.data.options.forEach(opt => {
                            const optName = opt.title?.English || opt.value || opt.id;
                            const optionId = `${questionId}-${opt.id}`;
                            const templateId = `${groupName}_${String(optName).toLowerCase().replace(/[^a-z0-9]/g, '_')}`;

                            // Create template for this option
                            templates[templateId] = {
                                name: `${questionName}: ${optName}`,
                                answerType: '17',
                                operator: '12',
                                key: questionId,
                                value: optionId
                            };

                            // Add quota with logic already set
                            newQuotas.push({
                                name: optName,
                                limit: 100,
                                group: questionName,
                                status: 'pending',
                                logic: {
                                    templateName: `${questionName}: ${optName}`,
                                    answerType: '17',
                                    operator: '12',
                                    key: questionId,
                                    value: optionId
                                },
                                originalIndex: createQuotasList.length + newQuotas.length
                            });
                        });
                    }
                } catch (e) {
                    console.error(`Error loading question ${questionId}:`, e);
                }

                // Small delay to avoid rate limiting
                await new Promise(r => setTimeout(r, 200));
            }

            // Save templates
            saveTemplates(templates);
            refreshTemplateDropdown();

            // Add to preview
            createQuotasList = [...createQuotasList, ...newQuotas];
            refreshBulkTemplateDropdown();
            renderCreatePreview();

            document.getElementById('createPreviewCard').classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = '‚úÖ Th√™m Questions ƒë√£ ch·ªçn v√†o Xem tr∆∞·ªõc';

            // Uncheck all
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllQuestions').checked = false;
            updateSelectedCount();

            alert(`‚úÖ ƒê√£ th√™m ${newQuotas.length} quota t·ª´ ${selectedCheckboxes.length} Questions!\n\nLogic ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông g√°n cho m·ªói quota.`);
        }

        // Quick Add functions for common question groups
        const COMMON_QUESTIONS = {
            93: 'age_group',
            75: 'family_income',
            87: 'province',
            150: 'gender'
        };

        async function quickAddQuestion(questionId, groupName) {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥...';

            try {
                const data = await alchemerAPI(`survey/${surveyId}/question/${questionId}`);

                if (!data || !data.result_ok || !data.data.options) {
                    alert(`‚ùå Kh√¥ng t√¨m th·∫•y Question ${questionId} ho·∫∑c kh√¥ng c√≥ options`);
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }

                const questionName = data.data.title?.English || groupName;
                let templates = getTemplates();
                let newQuotas = [];

                data.data.options.forEach(opt => {
                    const optName = opt.title?.English || opt.value || opt.id;
                    const optionId = `${questionId}-${opt.id}`;
                    const templateId = `${groupName}_${String(optName).toLowerCase().replace(/[^a-z0-9]/g, '_')}`;

                    templates[templateId] = {
                        name: `${groupName}: ${optName}`,
                        answerType: '17',
                        operator: '12',
                        key: String(questionId),
                        value: optionId
                    };

                    newQuotas.push({
                        name: optName,
                        limit: 100,
                        group: groupName,
                        status: 'pending',
                        logic: {
                            templateName: `${groupName}: ${optName}`,
                            answerType: '17',
                            operator: '12',
                            key: String(questionId),
                            value: optionId
                        },
                        originalIndex: createQuotasList.length + newQuotas.length
                    });
                });

                saveTemplates(templates);
                refreshTemplateDropdown();
                createQuotasList = [...createQuotasList, ...newQuotas];
                refreshBulkTemplateDropdown();
                renderCreatePreview();
                document.getElementById('createPreviewCard').classList.remove('hidden');

                btn.disabled = false;
                btn.textContent = originalText;
                alert(`‚úÖ ƒê√£ th√™m ${newQuotas.length} quota cho nh√≥m "${groupName}"!`);

            } catch (e) {
                console.error('Quick add error:', e);
                alert(`‚ùå L·ªói: ${e.message}`);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function quickAddMultipleQuestions(questionIds) {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang t·∫£i...';

            let totalAdded = 0;
            let templates = getTemplates();
            let newQuotas = [];

            for (const questionId of questionIds) {
                const groupName = COMMON_QUESTIONS[questionId] || `question_${questionId}`;

                try {
                    const data = await alchemerAPI(`survey/${surveyId}/question/${questionId}`);

                    if (data.result_ok && data.data.options) {
                        data.data.options.forEach(opt => {
                            const optName = opt.title?.English || opt.value || opt.id;
                            const optionId = `${questionId}-${opt.id}`;
                            const templateId = `${groupName}_${String(optName).toLowerCase().replace(/[^a-z0-9]/g, '_')}`;

                            templates[templateId] = {
                                name: `${groupName}: ${optName}`,
                                answerType: '17',
                                operator: '12',
                                key: String(questionId),
                                value: optionId
                            };

                            newQuotas.push({
                                name: optName,
                                limit: 100,
                                group: groupName,
                                status: 'pending',
                                logic: {
                                    templateName: `${groupName}: ${optName}`,
                                    answerType: '17',
                                    operator: '12',
                                    key: String(questionId),
                                    value: optionId
                                },
                                originalIndex: createQuotasList.length + newQuotas.length
                            });
                            totalAdded++;
                        });
                    }
                } catch (e) {
                    console.error(`Error loading question ${questionId}:`, e);
                }

                await new Promise(r => setTimeout(r, 200));
            }

            saveTemplates(templates);
            refreshTemplateDropdown();
            createQuotasList = [...createQuotasList, ...newQuotas];
            refreshBulkTemplateDropdown();
            renderCreatePreview();
            document.getElementById('createPreviewCard').classList.remove('hidden');

            btn.disabled = false;
            btn.textContent = originalText;
            alert(`‚úÖ ƒê√£ th√™m ${totalAdded} quota t·ª´ ${questionIds.length} nh√≥m!\n\n- age_group\n- family_income\n- province\n- gender`);
        }

        function useOptionId(optionId) {
            document.getElementById('logicAnswerType').value = '17';
            document.getElementById('logicOperator').value = '12';
            document.getElementById('logicKey').value = optionId.split('-')[0];
            document.getElementById('logicValue').value = optionId;
            updateLogicTypeUI();
            alert('‚úÖ ƒê√£ ƒëi·ªÅn Option ID: ' + optionId);
        }

        function updateLogicUI() {
            updateLogicPreview();
        }

        function updateLogicTypeUI() {
            const answerType = document.getElementById('logicAnswerType').value;
            const keyLabel = document.getElementById('logicKeyLabel');
            const keyHelp = document.getElementById('logicKeyHelp');
            const valueLabel = document.getElementById('logicValueLabel');
            const valueHelp = document.getElementById('logicValueHelp');
            const valueInput = document.getElementById('logicValue');
            const operatorSelect = document.getElementById('logicOperator');

            if (answerType === '17') {
                // Question Option
                keyLabel.textContent = 'Question ID';
                keyHelp.textContent = 'üí° ID c·ªßa c√¢u h·ªèi (VD: 93 cho c√¢u age_group)';
                valueLabel.textContent = 'Option ID (QuestionID-OptionID)';
                valueHelp.textContent = 'üí° Format: 93-10500 (xem API ƒë·ªÉ l·∫•y Option ID)';
                valueInput.placeholder = 'VD: 93-10500';
                // Set default operator to "is one of"
                operatorSelect.value = '12';
            } else {
                // Hidden Value
                keyLabel.textContent = 'Hidden Value ID';
                keyHelp.textContent = 'üí° ID c·ªßa Hidden Value (VD: 15 cho "link")';
                valueLabel.textContent = 'Gi√° tr·ªã (Value)';
                valueHelp.textContent = 'üí° Gi√° tr·ªã text ƒë·ªÉ so s√°nh';
                valueInput.placeholder = 'VD: panel';
                // Set default operator to "is exactly equal to"
                operatorSelect.value = '4';
            }
            updateLogicPreview();
        }

        function updateLogicPreview() {
            const operator = document.getElementById('logicOperator');
            const operatorText = operator.options[operator.selectedIndex].text.split(' (')[0];
            const logicKey = document.getElementById('logicKey').value || '?';
            const logicValue = document.getElementById('logicValue').value || '?';
            const preview = document.getElementById('logicPreview');
            const answerType = document.getElementById('logicAnswerType').value;

            const isAnsweredOp = ['20', '21'].includes(operator.value);
            const typeLabel = answerType === '17' ? 'Q' : 'HV';

            if (isAnsweredOp) {
                preview.textContent = `Logic: ${typeLabel}[${logicKey}] ${operatorText}`;
            } else {
                preview.textContent = `Logic: ${typeLabel}[${logicKey}] ${operatorText} "${logicValue}"`;
            }
        }

        // Update preview on input change
        document.addEventListener('DOMContentLoaded', () => {
            ['logicAnswerType', 'logicOperator', 'logicKey', 'logicValue'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateLogicPreview);
                if (el) el.addEventListener('input', updateLogicPreview);
            });
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active',
                    (tab === 'create' && i === 0) ||
                    (tab === 'manage' && i === 1) ||
                    (tab === 'delete' && i === 2));
            });
            document.getElementById('createTab').classList.toggle('active', tab === 'create');
            document.getElementById('manageTab').classList.toggle('active', tab === 'manage');
            document.getElementById('deleteTab').classList.toggle('active', tab === 'delete');
        }

        // ========== CREATE ==========
        function parseCreateData() {
            const data = document.getElementById('quotaData').value.trim();
            if (!data) return alert('Vui l√≤ng d√°n d·ªØ li·ªáu quota');

            createQuotasList = data.split('\n').map((line, idx) => {
                const parts = line.split('\t');
                return parts.length >= 2 ? {
                    name: parts[0].trim(),
                    limit: parseInt(parts[1]) || 100,
                    group: parts[2]?.trim() || 'Ch∆∞a ph√¢n nh√≥m',
                    status: 'pending',
                    logic: null,
                    originalIndex: idx
                } : null;
            }).filter(Boolean);

            createDeletedHistory = [];
            updateUndoVisibility();
            refreshBulkTemplateDropdown();

            renderCreatePreview();
            document.getElementById('createPreviewCard').classList.remove('hidden');
        }

        function refreshBulkTemplateDropdown() {
            const select = document.getElementById('bulkTemplate');
            const templates = getTemplates();
            select.innerHTML = '<option value="">-- Ch·ªçn template --</option>';
            for (const key in templates) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = templates[key].name;
                select.appendChild(opt);
            }
        }

        function getGroups() {
            const groups = {};
            createQuotasList.forEach((q, i) => {
                if (!groups[q.group]) groups[q.group] = [];
                groups[q.group].push({ ...q, index: i });
            });
            return groups;
        }

        function renderCreatePreview() {
            const groups = getGroups();
            const templates = getTemplates();
            const templateOptions = Object.entries(templates).map(([k, v]) =>
                `<option value="${k}">${v.name}</option>`
            ).join('');

            let html = '';
            for (const [groupName, items] of Object.entries(groups)) {
                const safeGroupName = escapeHtml(groupName);
                // Group header with template selector
                html += `<tr class="group-header" style="background: rgba(0,217,255,0.1);">
                    <td><input type="checkbox" class="group-checkbox" data-group="${safeGroupName}" onchange="toggleGroupSelect(this, '${safeGroupName}')"></td>
                    <td colspan="2"><strong>üìÅ ${safeGroupName}</strong> (${items.length} quota)</td>
                    <td colspan="2">
                        <select class="group-template" data-group="${safeGroupName}" style="font-size: 0.85rem; padding: 4px 8px;">
                            <option value="">-- Template --</option>
                            ${templateOptions}
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="applyGroupTemplate('${safeGroupName}')" style="margin-left: 8px;">‚úÖ</button>
                    </td>
                    <td colspan="2"></td>
                </tr>`;

                // Group items
                items.forEach(q => {
                    const logicDisplay = q.logic ?
                        `<span class="status status-success" style="font-size: 0.75rem;">${escapeHtml(q.logic.templateName || 'Custom')}</span>` :
                        '<span class="status status-pending" style="font-size: 0.75rem;">‚Äî</span>';
                    html += `<tr id="create-row-${q.index}">
                        <td><input type="checkbox" class="quota-checkbox" data-index="${q.index}" data-group="${safeGroupName}"></td>
                        <td>${q.index + 1}</td>
                        <td><input type="text" value="${escapeHtml(q.name)}" onchange="updateCreateName(${q.index}, this.value)" style="width: 100%;"></td>
                        <td><input type="number" value="${q.limit}" onchange="updateCreateLimit(${q.index}, this.value)" style="width: 70px;"></td>
                        <td>${logicDisplay}</td>
                        <td><span class="status status-pending">‚è≥</span></td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteCreateRow(${q.index})">üóëÔ∏è</button></td>
                    </tr>`;
                });
            }
            document.getElementById('createPreviewBody').innerHTML = html;
        }

        function toggleGroupSelect(checkbox, groupName) {
            document.querySelectorAll(`.quota-checkbox[data-group="${groupName}"]`).forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function applyGroupTemplate(groupName) {
            const select = document.querySelector(`.group-template[data-group="${groupName}"]`);
            const templateId = select.value;
            if (!templateId) return alert('Vui l√≤ng ch·ªçn template');

            const templates = getTemplates();
            const t = templates[templateId];
            if (!t) return;

            let count = 0;
            createQuotasList.forEach((q, i) => {
                if (q.group === groupName) {
                    q.logic = {
                        templateName: t.name,
                        answerType: t.answerType,
                        operator: t.operator,
                        key: t.key,
                        value: t.value
                    };
                    count++;
                }
            });

            renderCreatePreview();
            alert(`‚úÖ ƒê√£ √°p d·ª•ng "${t.name}" cho ${count} quota trong nh√≥m "${groupName}"`);
        }

        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.quota-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function getSelectedIndices() {
            const indices = [];
            document.querySelectorAll('.quota-checkbox:checked').forEach(cb => {
                indices.push(parseInt(cb.dataset.index));
            });
            return indices;
        }

        function applyBulkTemplate() {
            const templateId = document.getElementById('bulkTemplate').value;
            if (!templateId) return alert('Vui l√≤ng ch·ªçn template');

            const indices = getSelectedIndices();
            if (indices.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 quota');

            const templates = getTemplates();
            const t = templates[templateId];
            if (!t) return alert('Template kh√¥ng t·ªìn t·∫°i');

            indices.forEach(i => {
                createQuotasList[i].logic = {
                    templateName: t.name,
                    answerType: t.answerType,
                    operator: t.operator,
                    key: t.key,
                    value: t.value
                };
            });

            renderCreatePreview();
            document.getElementById('selectAllQuotas').checked = false;
            alert(`‚úÖ ƒê√£ √°p d·ª•ng "${t.name}" cho ${indices.length} quota`);
        }

        function clearSelectedLogic() {
            const indices = getSelectedIndices();
            if (indices.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 quota');

            indices.forEach(i => {
                createQuotasList[i].logic = null;
            });

            renderCreatePreview();
            document.getElementById('selectAllQuotas').checked = false;
            alert(`‚úÖ ƒê√£ x√≥a logic c·ªßa ${indices.length} quota`);
        }

        function updateCreateName(index, value) {
            createQuotasList[index].name = value.trim();
        }

        function updateCreateLimit(index, value) {
            createQuotasList[index].limit = parseInt(value) || 0;
        }

        function deleteCreateRow(index) {
            const item = createQuotasList.splice(index, 1)[0];
            createDeletedHistory.push({ item, index });
            renderCreatePreview();
            updateUndoVisibility();
            if (createQuotasList.length === 0) {
                document.getElementById('createPreviewCard').classList.add('hidden');
            }
        }

        function addManualQuota() {
            const name = prompt('Nh·∫≠p t√™n quota:', 'New Quota');
            if (!name) return;

            const limit = parseInt(prompt('Nh·∫≠p limit:', '100')) || 100;
            const group = prompt('Nh·∫≠p nh√≥m (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥):', '') || 'Th·ªß c√¥ng';

            createQuotasList.push({
                name: name,
                limit: limit,
                group: group,
                status: 'pending',
                logic: null,
                originalIndex: createQuotasList.length
            });

            renderCreatePreview();
            document.getElementById('createPreviewCard').classList.remove('hidden');
        }

        function undoDelete() {
            if (createDeletedHistory.length === 0) return;
            const last = createDeletedHistory.pop();
            createQuotasList.splice(last.index, 0, last.item);
            renderCreatePreview();
            updateUndoVisibility();
            document.getElementById('createPreviewCard').classList.remove('hidden');
        }

        function updateUndoVisibility() {
            const btn = document.getElementById('undoBtn');
            if (createDeletedHistory.length > 0) {
                btn.classList.remove('hidden');
                btn.innerHTML = `‚Ü©Ô∏è Ho√†n t√°c (${createDeletedHistory.length})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function createQuotas() {
            if (!createQuotasList.length) { parseCreateData(); if (!createQuotasList.length) return; }
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');
            saveSettings();

            const btn = document.getElementById('createBtn');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ƒêang t·∫°o...';

            const globalEnableLogic = document.getElementById('enableLogic').checked;
            const globalLogicAnswerType = document.getElementById('logicAnswerType').value;
            const globalLogicOperator = document.getElementById('logicOperator').value;
            const globalLogicKey = document.getElementById('logicKey').value;
            const globalLogicValue = document.getElementById('logicValue').value;

            let success = 0, errors = 0;

            for (let i = 0; i < createQuotasList.length; i++) {
                const q = createQuotasList[i];
                try {
                    // Use individual logic if set, otherwise use global logic
                    let useLogic = q.logic || (globalEnableLogic && globalLogicKey ? {
                        answerType: globalLogicAnswerType,
                        operator: globalLogicOperator,
                        key: globalLogicKey,
                        value: globalLogicValue
                    } : null);

                    const params = {
                        _method: 'PUT',
                        name: q.name,
                        limit: q.limit
                    };

                    if (useLogic && useLogic.key) {
                        const isAnsweredOp = ['20', '21'].includes(useLogic.operator);

                        let answersValues;
                        if (isAnsweredOp) {
                            answersValues = "";
                        } else if (useLogic.answerType === '17') {
                            // Check if value is already an array (merged quota)
                            if (Array.isArray(useLogic.value)) {
                                answersValues = useLogic.value;
                            } else {
                                answersValues = [useLogic.value];
                            }
                        } else {
                            answersValues = useLogic.value;
                        }

                        const groupsObj = [{
                            rules: [{
                                input_value: useLogic.key,
                                operator: useLogic.operator,
                                answers_type: useLogic.answerType,
                                answers_values: answersValues
                            }]
                        }];
                        params.groups = JSON.stringify(groupsObj);
                    }

                    const data = await alchemerAPI(`survey/${surveyId}/quotas`, 'POST', params);

                    const row = document.querySelector(`#create-row-${i} .status`);

                    if (data && data.result_ok) {
                        row.className = 'status status-success';
                        row.textContent = '‚úÖ OK';
                        success++;
                    } else {
                        row.className = 'status status-error';
                        row.textContent = `‚ùå ${data?.message || 'L·ªói API'}`;
                        console.error('API Error:', data);
                        errors++;
                    }
                } catch (e) {
                    const row = document.querySelector(`#create-row-${i} .status`);
                    row.className = 'status status-error';
                    row.textContent = '‚ùå L·ªói m·∫°ng/CORS';
                    console.error('Fetch error:', e);
                    errors++;
                }
                await new Promise(r => setTimeout(r, 300));
            }

            document.getElementById('createTotal').textContent = createQuotasList.length;
            document.getElementById('createSuccess').textContent = success;
            document.getElementById('createError').textContent = errors;
            document.getElementById('createResultsCard').classList.remove('hidden');
            btn.disabled = false; btn.innerHTML = '‚ú® T·∫°o Quota';
        }

        // ========== MANAGE ==========
        async function loadExistingQuotas() {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');
            saveSettings();

            const btn = document.getElementById('loadManageBtn');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ƒêang t·∫£i...';

            try {
                const data = await alchemerAPI(`survey/${surveyId}/quotas`);

                if (data && data.result_ok) {
                    // API returns quotas in data.quotas or data.data depending on version
                    const quotas = data.quotas || data.data || [];
                    manageQuotasList = quotas.map(q => ({ ...q, originalLimit: parseInt(q.limit), newLimit: parseInt(q.limit), status: '' }));
                    renderManageTable();
                    document.getElementById('manageCard').classList.remove('hidden');
                    document.getElementById('manageActions').classList.remove('hidden');
                } else alert('L·ªói: ' + (data?.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch'));
            } catch (e) { alert('L·ªói: ' + e.message); }

            btn.disabled = false; btn.innerHTML = 'üîÑ T·∫£i danh s√°ch Quota';
        }

        function renderManageTable() {
            document.getElementById('manageBody').innerHTML = manageQuotasList.map((q, i) => {
                const change = q.newLimit - q.originalLimit;
                const changeText = change !== 0 ? `<span class="change-indicator ${change > 0 ? 'change-up' : 'change-down'}">${change > 0 ? '+' : ''}${change}</span>` : '';
                const statusClass = change !== 0 ? 'status-modified' : '';
                const statusText = q.status || (change !== 0 ? 'üìù ƒê√£ s·ª≠a' : '');
                return `<tr id="manage-row-${i}">
                    <td><input type="checkbox" class="manage-check" data-index="${i}"></td>
                    <td>${q.id}</td>
                    <td>${q.name}</td>
                    <td>${q.originalLimit}</td>
                    <td><input type="number" value="${q.newLimit}" onchange="updateNewLimit(${i}, this.value)">${changeText}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                </tr>`;
            }).join('');
        }

        function updateNewLimit(index, value) {
            manageQuotasList[index].newLimit = parseInt(value) || 0;
            renderManageTable();
        }

        function applyAdjustment() {
            const type = document.getElementById('adjustType').value;
            const value = parseFloat(document.getElementById('adjustValue').value) || 0;

            const checked = document.querySelectorAll('.manage-check:checked');
            const indices = checked.length > 0 ? Array.from(checked).map(c => parseInt(c.dataset.index)) : manageQuotasList.map((_, i) => i);

            indices.forEach(i => {
                const q = manageQuotasList[i];
                if (type === 'percent') q.newLimit = Math.round(q.originalLimit * (1 + value / 100));
                else if (type === 'add') q.newLimit = q.originalLimit + value;
                else if (type === 'set') q.newLimit = value;
            });
            renderManageTable();
        }

        function resetLimits() {
            manageQuotasList.forEach(q => q.newLimit = q.originalLimit);
            renderManageTable();
        }

        function toggleSelectAllManage() {
            const checked = document.getElementById('selectAllManage').checked;
            document.querySelectorAll('.manage-check').forEach(c => c.checked = checked);
        }

        async function updateQuotas() {
            const { surveyId } = getApiParams();
            const toUpdate = manageQuotasList.filter((q, i) => {
                const checkbox = document.querySelector(`.manage-check[data-index="${i}"]`);
                return checkbox?.checked && q.newLimit !== q.originalLimit;
            });

            if (!toUpdate.length) return alert('Vui l√≤ng ch·ªçn quota ƒë√£ ch·ªânh s·ª≠a ƒë·ªÉ c·∫≠p nh·∫≠t');

            const btn = document.getElementById('updateBtn');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ƒêang c·∫≠p nh·∫≠t...';

            let success = 0, errors = 0;

            for (const q of toUpdate) {
                try {
                    const data = await alchemerAPI(`survey/${surveyId}/quotas/${q.id}`, 'POST', { _method: 'POST', limit: q.newLimit });

                    if (data && data.result_ok) { q.originalLimit = q.newLimit; q.status = '‚úÖ ƒê√£ l∆∞u'; success++; }
                    else { q.status = '‚ùå L·ªói'; errors++; }
                } catch (e) { q.status = '‚ùå L·ªói'; errors++; }
                await new Promise(r => setTimeout(r, 300));
            }

            renderManageTable();
            document.getElementById('updateTotal').textContent = toUpdate.length;
            document.getElementById('updateSuccess').textContent = success;
            document.getElementById('updateError').textContent = errors;
            document.getElementById('updateResultsCard').classList.remove('hidden');
            btn.disabled = false; btn.innerHTML = 'üíæ C·∫≠p nh·∫≠t Quota ƒë√£ ch·ªçn';
        }

        // ========== DELETE ==========
        async function loadDeleteQuotas() {
            const { surveyId } = getApiParams();
            if (!surveyId) return alert('Vui l√≤ng nh·∫≠p Survey ID');
            saveSettings();

            const btn = document.getElementById('loadDeleteBtn');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ƒêang t·∫£i...';

            try {
                const data = await alchemerAPI(`survey/${surveyId}/quotas`);

                if (data && data.result_ok) {
                    deleteQuotasList = data.quotas || data.data || [];
                    document.getElementById('deleteCheckboxes').innerHTML = deleteQuotasList.map(q =>
                        `<div class="checkbox-item"><input type="checkbox" id="del-${q.id}" value="${q.id}" class="delete-check"><label for="del-${q.id}">${q.name} (ID: ${q.id}, Limit: ${q.limit})</label></div>`
                    ).join('');
                    document.getElementById('deleteList').classList.remove('hidden');
                    document.getElementById('deleteBtn').classList.remove('hidden');
                } else alert('L·ªói: ' + (data?.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch'));
            } catch (e) { alert('L·ªói: ' + e.message); }

            btn.disabled = false; btn.innerHTML = 'üîÑ T·∫£i danh s√°ch';
        }

        function toggleSelectAllDelete() {
            const checked = document.getElementById('selectAllDelete').checked;
            document.querySelectorAll('.delete-check').forEach(c => c.checked = checked);
        }

        async function deleteSelectedQuotas() {
            const selected = Array.from(document.querySelectorAll('.delete-check:checked')).map(c => c.value);
            if (!selected.length) return alert('Ch·ªçn √≠t nh·∫•t 1 quota');
            if (!confirm(`Xo√° ${selected.length} quota? Kh√¥ng th·ªÉ ho√†n t√°c!`)) return;

            const { surveyId } = getApiParams();
            const btn = document.getElementById('deleteBtn');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ƒêang xo√°...';

            let success = 0, errors = 0;
            for (const id of selected) {
                try {
                    const data = await alchemerAPI(`survey/${surveyId}/quotas/${id}`, 'POST', { _method: 'DELETE' });
                    if (data && data.result_ok) { document.querySelector(`#del-${id}`)?.closest('.checkbox-item')?.remove(); success++; }
                    else errors++;
                } catch (e) { errors++; }
                await new Promise(r => setTimeout(r, 300));
            }

            document.getElementById('deleteTotal').textContent = selected.length;
            document.getElementById('deleteSuccess').textContent = success;
            document.getElementById('deleteError').textContent = errors;
            document.getElementById('deleteResultsCard').classList.remove('hidden');
            btn.disabled = false; btn.innerHTML = 'üóëÔ∏è Xo√° Quota';
        }
    </script>
</body>

</html>